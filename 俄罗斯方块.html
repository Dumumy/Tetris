<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        p {
            margin-top: 50px;
            text-align: center;
        }
        
        table {
            margin: 50px auto;
        }
        
        td {
            width: 15px;
            height: 15px;
            border: 1px solid red;
        }
        
        h3 {
            text-align: center;
        }
    </style>
</head>

<body>
    <p>按回车进入游戏</p>
    <h3>得分：</h3>
    <table>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>
</body>
<script>
    var begin = true;
    var square;
    var squArr = [
        [-1, -1],
        [-1, -1],
        [-1, -1],
        [-1, -1]
    ];
    var dir;
    var target = [
        [-1, -1],
        [-1, -1],
        [-1, -1],
        [-1, -1]
    ];
    var speed = 500; //时间戳,ms
    var score = 0;
    window.onload = function() {
        initWall();
        // randSquare();
        // map();
        document.onkeydown = function(event) {
                e = event || window.enent;
                switch (e.keyCode) {
                    case 13: //回车键
                        enterGame();
                        break;
                    case 37: //小键盘"左"键
                        moveLeft();
                        break;
                    case 38: //小键盘"上"键
                        keyUp();
                        break;
                    case 39: //小键盘"右"键
                        moveRight();
                        break;
                    case 40: //小键盘"下"键
                        moveDown();
                        break;
                }
            }
            // testRandom();
            // alert(square);
    }

    function moveDown() {
        target = [
            [-1, -1],
            [-1, -1],
            [-1, -1],
            [-1, -1]
        ];
        hidden();
        for (var i = 0; i < 4; i++) {
            target[i][0] = squArr[i][0] + 1;
            target[i][1] = squArr[i][1];
        }
        if (canMove()) {
            squArr = target;
        } else { //不能移动显示方块，判断有无可加分行
            map();
            checkLines();
            randSquare();
        }
        map();
    }

    function checkLines() {
        for (var i = 18; i > 1; i--) {
            var check = true;
            for (var j = 1; j < 9; j++) {
                if (document.getElementsByTagName("td")[i * 10 + j].style.backgroundColor != "blue") {
                    check = false;
                    break;
                }
            }
            if (check) {
                score += 10;
                document.getElementsByTagName("h3")[0].innerHTML = "得分：" + score;
                for (var k = i; k > 1; k--) {
                    for (var L = 1; L < 9; L++) {
                        document.getElementsByTagName("td")[k * 10 + L].style.backgroundColor = document.getElementsByTagName("td")[(k - 1) * 10 + L].style.backgroundColor;
                    }
                }
                i++;
            }
        }
    }

    function enterGame() {
        if (begin) {
            randSquare();
            map();
            setInterval("moveDown()", speed);
            begin = false;
        }
    }

    function moveLeft() { //左移
        target = [
            [-1, -1],
            [-1, -1],
            [-1, -1],
            [-1, -1]
        ];
        hidden();
        for (var i = 0; i < 4; i++) {
            target[i][0] = squArr[i][0];
            target[i][1] = squArr[i][1] - 1;
        };
        if (canMove()) {
            squArr = target;
            map()
        } else {
            map();
        }
    }

    function moveRight() { //右移
        target = [
            [-1, -1],
            [-1, -1],
            [-1, -1],
            [-1, -1]
        ];
        hidden();
        for (var i = 0; i < 4; i++) {
            target[i][0] = squArr[i][0];
            target[i][1] = squArr[i][1] + 1;
        };
        if (canMove()) {
            squArr = target;
            map()
        } else {
            map();
        }
    }

    function keyUp() { //切换方块的形状，基于每种图形的原点进行变换(围绕原点加减修正值，算出另外三个点的位置)
        target = [
            [-1, -1],
            [-1, -1],
            [-1, -1],
            [-1, -1]
        ];
        switch (square) {
            case 0: //田，不变
                break;
            case 1: //7字，变 L 7 
                switch (dir % 4) {
                    case 0: //7变__|
                        hidden();
                        target[0][0] = squArr[2][0] - 1;
                        target[0][1] = squArr[2][1] + 1;
                        target[1][0] = squArr[2][0];
                        target[1][1] = squArr[2][1] + 1;
                        target[2][0] = squArr[2][0];
                        target[2][1] = squArr[2][1];
                        target[3][0] = squArr[2][0];
                        target[3][1] = squArr[2][1] - 1;
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 1: //___|变L
                        hidden();
                        target[0][0] = squArr[2][0] + 1;
                        target[0][1] = squArr[2][1] + 1;
                        target[1][0] = squArr[2][0] + 1;
                        target[1][1] = squArr[2][1];
                        target[2][0] = squArr[2][0];
                        target[2][1] = squArr[2][1];
                        target[3][0] = squArr[2][0] - 1;
                        target[3][1] = squArr[2][1];
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 2: //L变 |`````
                        hidden();
                        target[0][0] = squArr[2][0] + 1;
                        target[0][1] = squArr[2][1] - 1;
                        target[1][0] = squArr[2][0];
                        target[1][1] = squArr[2][1] - 1;
                        target[2][0] = squArr[2][0];
                        target[2][1] = squArr[2][1];
                        target[3][0] = squArr[2][0];
                        target[3][1] = squArr[2][1] + 1;
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 3: // |````变 7
                        hidden();
                        target[0][0] = squArr[2][0] - 1;
                        target[0][1] = squArr[2][1] - 1;
                        target[1][0] = squArr[2][0] - 1;
                        target[1][1] = squArr[2][1];
                        target[2][0] = squArr[2][0];
                        target[2][1] = squArr[2][1];
                        target[3][0] = squArr[2][0] + 1;
                        target[3][1] = squArr[2][1];
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                }
                break;
            case 2: //长条，变 || ----，两种形态，横条，竖条，相互变换
                if (dir % 2) {
                    //值为1，竖条变横条
                    hidden();
                    target[0][0] = squArr[0][0];
                    target[0][1] = squArr[0][1];
                    target[1][0] = squArr[0][0];
                    target[1][1] = squArr[0][1] + 1;
                    target[2][0] = squArr[0][0];
                    target[2][1] = squArr[0][1] + 2;
                    target[3][0] = squArr[0][0];
                    target[3][1] = squArr[0][1] + 3;
                    if (canMove()) {
                        squArr = target;
                        dir++;
                    }
                    map();
                } else {
                    //值为0，横条变竖条
                    hidden();
                    target[0][0] = squArr[0][0];
                    target[0][1] = squArr[0][1];
                    target[1][0] = squArr[0][0] + 1;
                    target[1][1] = squArr[0][1];
                    target[2][0] = squArr[0][0] + 2;
                    target[2][1] = squArr[0][1];
                    target[3][0] = squArr[0][0] + 3;
                    target[3][1] = squArr[0][1];
                    if (canMove()) {
                        squArr = target;
                        dir++;
                    }
                    map();
                }
                break;
            case 3: //T字，变 |-  -|
                switch (dir % 4) { //变换规则，顺时针变换，上变右，右变下，下变左，左变上
                    case 0: //山峰朝右 朝右变朝下
                        hidden();
                        target[0][0] = squArr[1][0];
                        target[0][1] = squArr[1][1] + 1;
                        target[1][0] = squArr[1][0];
                        target[1][1] = squArr[1][1];
                        target[2][0] = squArr[1][0];
                        target[2][1] = squArr[1][1] - 1;
                        target[3][0] = squArr[1][0] + 1;
                        target[3][1] = squArr[1][1];
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 1: //山峰朝下 朝下变朝左
                        hidden();
                        target[0][0] = squArr[1][0] - 1;
                        target[0][1] = squArr[1][1];
                        target[1][0] = squArr[1][0];
                        target[1][1] = squArr[1][1];
                        target[2][0] = squArr[1][0] + 1;
                        target[2][1] = squArr[1][1];
                        target[3][0] = squArr[1][0];
                        target[3][1] = squArr[1][1] - 1;
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 2: //山峰朝左 朝左变朝上
                        hidden();
                        target[0][0] = squArr[1][0];
                        target[0][1] = squArr[1][1] + 1;
                        target[1][0] = squArr[1][0];
                        target[1][1] = squArr[1][1];
                        target[2][0] = squArr[1][0];
                        target[2][1] = squArr[1][1] - 1;
                        target[3][0] = squArr[1][0] - 1;
                        target[3][1] = squArr[1][1];
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                    case 3: //山峰朝上 朝上变朝右
                        hidden();
                        target[0][0] = squArr[1][0] - 1;
                        target[0][1] = squArr[1][1];
                        target[1][0] = squArr[1][0];
                        target[1][1] = squArr[1][1];
                        target[2][0] = squArr[1][0] + 1;
                        target[2][1] = squArr[1][1];
                        target[3][0] = squArr[1][0];
                        target[3][1] = squArr[1][1] + 1;
                        if (canMove()) {
                            squArr = target;
                            dir++;
                        }
                        map();
                        break;
                }
                break;
            case 4: //横左变竖左，竖左变横左
                if (dir % 2) { //0，竖变横
                    hidden();
                    target[0][0] = squArr[2][0] - 1;
                    target[0][1] = squArr[2][1] - 1;
                    target[1][0] = squArr[2][0] - 1;
                    target[1][1] = squArr[2][1];
                    target[2][0] = squArr[2][0];
                    target[2][1] = squArr[2][1];
                    target[3][0] = squArr[2][0];
                    target[3][1] = squArr[2][1] + 1;
                    if (canMove()) {
                        squArr = target;
                        dir++;
                    }
                    map();
                    break;
                } else { //1，横变竖
                    hidden();
                    target[0][0] = squArr[2][0] - 1;
                    target[0][1] = squArr[2][1] + 1;
                    target[1][0] = squArr[2][0];
                    target[1][1] = squArr[2][1] + 1;
                    target[2][0] = squArr[2][0];
                    target[2][1] = squArr[2][1];
                    target[3][0] = squArr[2][0] + 1;
                    target[3][1] = squArr[2][1];
                    if (canMove()) {
                        squArr = target;
                        dir++;
                    }
                    map();
                    break;
                }
                break;
        }
    }


    function hidden() { //移动之前需要先把自身隐藏，才能移动
        for (var i = 0; i < 4; i++) {
            document.getElementsByTagName("td")[squArr[i][0] * 10 + squArr[i][1]].style.backgroundColor = "white";
        }
    }

    function canMove() { //碰撞检测，如果是红色的墙，则不能移动
        for (var i = 0; i < 4; i++) {
            if (document.getElementsByTagName("td")[target[i][0] * 10 + target[i][1]].style.backgroundColor == "red")
                return false;
        };
        return true;
    }

    function randSquare() {
        square = Math.floor(Math.random() * 5);

        switch (square) {
            case 0: //田
                squArr = [
                    [1, 4],
                    [1, 5],
                    [2, 4],
                    [2, 5]
                ];
                dir = 0;
                break;
            case 1: //7字
                squArr = [
                    [1, 4],
                    [1, 5],
                    [2, 5],
                    [3, 5]
                ];
                dir = 0;
                break;
            case 2: //长条
                squArr = [
                    [1, 3],
                    [1, 4],
                    [1, 5],
                    [1, 6]
                ];
                dir = 0;
                break;
            case 3: //T字
                squArr = [
                    [1, 4],
                    [2, 4],
                    [3, 4],
                    [2, 5]
                ];
                dir = 0;
                break;
            case 4: //左
                squArr = [
                    [1, 4],
                    [2, 4],
                    [2, 5],
                    [3, 5]
                ];
                dir = 0;
                break;
        }
    }

    function map() {
        for (var i = 0; i < 4; i++) {
            document.getElementsByTagName("td")[squArr[i][0] * 10 + squArr[i][1]].style.backgroundColor = "blue";
        }
    }
    // function testRandom() {
    //     square = Math.floor(Math.random() * 10) % 5;
    // }

    function initWall() {
        for (let i = 0; i < 10; i++) {
            document.getElementsByClassName
            document.getElementsByTagName('td')[i].style.backgroundColor = 'red';
            document.getElementsByTagName('td')[19 * 10 + i].style.backgroundColor = 'red';
        };
        for (let i = 0; i < 20; i++) {
            document.getElementsByTagName('td')[10 * i].style.backgroundColor = 'red';
            document.getElementsByTagName('td')[10 * i + 9].style.backgroundColor = 'red';
        }
    }
</script>

</html>